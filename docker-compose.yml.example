version: '3'

networks:
  backend:
    driver: bridge

services:

  ### Web Server #######################################
  web:
    build:
      context: ../
      dockerfile: docker/php/Dockerfile
      args:
        - COMPOSER_INSTALL=${PHP_COMPOSER_INSTALL}
        - COMPOSER_INSTALL_DEV=${PHP_COMPOSER_INSTALL_DEV}
        - INSTALL_SSH2=${PHP_INSTALL_SSH2}
        - INSTALL_SOAP=${PHP_INSTALL_SOAP}
        - INSTALL_XSL=${PHP_INSTALL_XSL}
        - INSTALL_BCMATH=${PHP_INSTALL_BCMATH}
        - INSTALL_IMAP=${PHP_INSTALL_IMAP}
        - INSTALL_IMAGICK=${PHP_INSTALL_IMAGICK}
        - INSTALL_MYSQLI=${PHP_INSTALL_MYSQLI}
        - INSTALL_MSSQL=${PHP_INSTALL_MSSQL}
        - INSTALL_MONGO=${PHP_INSTALL_MONGO}
        - INSTALL_PGSQL=${PHP_INSTALL_PGSQL}
        - INSTALL_SOCKETS=${PHP_INSTALL_SOCKETS}
        - INSTALL_RDKAFKA=${PHP_INSTALL_RDKAFKA}
        - INSTALL_PHPREDIS=${PHP_INSTALL_PHPREDIS}
        - INSTALL_NODE=${PHP_INSTALL_NODE}
        - INSTALL_YARN=${PHP_INSTALL_YARN}
    volumes:
      - ${APP_CODE_PATH_HOST}:/var/www${APP_CODE_CONTAINER_FLAG}
      - ./php/php.ini:/usr/local/etc/php/php.ini
      - ./php/opcache.ini:/usr/local/etc/php/conf.d/opcache.ini
      - ./php/xdebug.ini:/usr/local/etc/php/conf.d/xdebug.ini
      - ../deploy/shared/web/supervisord.d:/etc/supervisord.d
    expose:
      - ${NGINX_PHP_FPM_PORT}
      - ${NGINX_PHP_SWOOLE_PORT}
    environment:
      - PHP_IDE_CONFIG=serverName=docker
    networks:
      - backend

  ### Worker Server ####################################
  worker:
    build:
      context: ../
      dockerfile: docker/php/Dockerfile
      args:
        - COMPOSER_INSTALL=${PHP_COMPOSER_INSTALL}
        - COMPOSER_INSTALL_DEV=${PHP_COMPOSER_INSTALL_DEV}
        - INSTALL_SSH2=${PHP_INSTALL_SSH2}
        - INSTALL_SOAP=${PHP_INSTALL_SOAP}
        - INSTALL_XSL=${PHP_INSTALL_XSL}
        - INSTALL_BCMATH=${PHP_INSTALL_BCMATH}
        - INSTALL_IMAP=${PHP_INSTALL_IMAP}
        - INSTALL_IMAGICK=${PHP_INSTALL_IMAGICK}
        - INSTALL_MYSQLI=${PHP_INSTALL_MYSQLI}
        - INSTALL_MSSQL=${PHP_INSTALL_MSSQL}
        - INSTALL_MONGO=${PHP_INSTALL_MONGO}
        - INSTALL_PGSQL=${PHP_INSTALL_PGSQL}
        - INSTALL_SOCKETS=${PHP_INSTALL_SOCKETS}
        - INSTALL_RDKAFKA=${PHP_INSTALL_RDKAFKA}
        - INSTALL_PHPREDIS=${PHP_INSTALL_PHPREDIS}
        - INSTALL_NODE=${PHP_INSTALL_NODE}
        - INSTALL_YARN=${PHP_INSTALL_YARN}
    volumes:
      - ${APP_CODE_PATH_HOST}:/var/www${APP_CODE_CONTAINER_FLAG}
      - ./php/php.ini:/usr/local/etc/php/php.ini
      - ./php/opcache.ini:/usr/local/etc/php/conf.d/opcache.ini
      - ./php/xdebug.ini:/usr/local/etc/php/conf.d/xdebug.ini
      - ../deploy/shared/worker/supervisord.d:/etc/supervisord.d
    networks:
      - backend

  ### NGINX Server #####################################
  nginx:
    build:
      context: ../
      dockerfile: docker/nginx/Dockerfile
      args:
        - PHP_FPM_PORT=${NGINX_PHP_FPM_PORT}
        - PHP_SWOOLE_PORT=${NGINX_PHP_SWOOLE_PORT}
    volumes:
      - ${APP_CODE_PATH_HOST}/public:/var/www/public${APP_CODE_CONTAINER_FLAG}
      - ../deploy/shared/nginx/sites/:/etc/nginx/sites-available
      - ./logs/nginx/:/var/log/nginx
      - ./nginx/ssl/:/etc/nginx/ssl
    ports:
      - "${NGINX_HOST_HTTP_PORT}:80"
      - "${NGINX_HOST_HTTPS_PORT}:443"
    depends_on:
      - web
    networks:
      - backend
